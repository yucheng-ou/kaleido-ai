<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="com.xiaoo.kaleido.admin.infrastructure.dao.AdminDao">
    
    <!-- 1. ResultMap定义 -->
    <resultMap id="AdminMap" type="com.xiaoo.kaleido.admin.infrastructure.dao.po.AdminPO">
        <!-- 继承BasePO的字段映射 -->
        <result property="id" column="id"/>
        <result property="createdAt" column="created_at"/>
        <result property="updatedAt" column="updated_at"/>
        <result property="deleted" column="deleted"/>
        <result property="lockVersion" column="lock_version"/>
        
        <!-- AdminPO特有字段 -->
        <result property="realName" column="real_name"/>
        <result property="mobile" column="mobile"/>
        <result property="status" column="status"/>
        <result property="lastLoginTime" column="last_login_time"/>
    </resultMap>
    
    <!-- 2. 可重用SQL片段 -->
    <sql id="AdminColumns">
        id, real_name, mobile, status, last_login_time
    </sql>
    
    <!-- 3. 查询语句 -->
    
    <!-- 根据ID查找管理员 -->
    <select id="findById" resultMap="AdminMap">
        SELECT <include refid="AdminColumns"/>
        FROM t_admin
        WHERE id = #{id} AND deleted = 0
    </select>
    
    <!-- 根据手机号查找管理员 -->
    <select id="findByMobile" resultMap="AdminMap">
        SELECT <include refid="AdminColumns"/>
        FROM t_admin
        WHERE mobile = #{mobile} AND deleted = 0
    </select>
    
    <!-- 检查手机号是否存在 -->
    <select id="existsByMobile" resultType="boolean">
        SELECT COUNT(*) > 0
        FROM t_admin
        WHERE mobile = #{mobile} AND deleted = 0
    </select>
    
    <!-- 分页查询管理员 -->
    <select id="pageQuery" resultMap="AdminMap">
        SELECT <include refid="AdminColumns"/>
        FROM t_admin
        WHERE deleted = 0
        <if test="queryReq.realName != null and queryReq.realName != ''">
            AND real_name LIKE CONCAT('%', #{queryReq.realName}, '%')
        </if>
        <if test="queryReq.mobile != null and queryReq.mobile != ''">
            AND mobile LIKE CONCAT('%', #{queryReq.mobile}, '%')
        </if>
        <if test="queryReq.status != null and queryReq.status != ''">
            AND status = #{queryReq.status}
        </if>
        <if test="queryReq.roleId != null and queryReq.roleId != ''">
            AND id IN (
                SELECT admin_id 
                FROM t_admin_role 
                WHERE role_id = #{queryReq.roleId}
            )
        </if>
        <if test="queryReq.startTime != null and queryReq.startTime != ''">
            AND created_at <![CDATA[ >= ]]> #{queryReq.startTime}
        </if>
        <if test="queryReq.endTime != null and queryReq.endTime != ''">
            AND created_at <![CDATA[ <= ]]> #{queryReq.endTime}
        </if>
        ORDER BY created_at DESC
    </select>
</mapper>
