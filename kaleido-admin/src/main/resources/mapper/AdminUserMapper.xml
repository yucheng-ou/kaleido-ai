<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="com.xiaoo.kaleido.admin.infrastructure.dao.AdminUserDao">
    
    <!-- 1. ResultMap定义 -->
    <resultMap id="AdminUserMap" type="com.xiaoo.kaleido.admin.infrastructure.dao.po.AdminUserPO">
        <!-- 继承BasePO的字段映射 -->
        <result property="id" column="id"/>
        <result property="createdAt" column="created_at"/>
        <result property="updatedAt" column="updated_at"/>
        <result property="deleted" column="deleted"/>
        <result property="lockVersion" column="lock_version"/>
        
        <!-- AdminUserPO特有字段 -->
        <result property="username" column="username"/>
        <result property="passwordHash" column="password_hash"/>
        <result property="realName" column="real_name"/>
        <result property="mobile" column="mobile"/>
        <result property="status" column="status"/>
        <result property="lastLoginTime" column="last_login_time"/>
    </resultMap>
    
    <!-- 2. 可重用SQL片段 -->
    <sql id="AdminUserColumns">
        id, username, password_hash, real_name, mobile, status, last_login_time,
        created_at, updated_at, deleted, lock_version
    </sql>
    
    <!-- 3. 查询语句 -->
    
    <!-- 根据ID查找管理员 -->
    <select id="findById" resultMap="AdminUserMap">
        SELECT <include refid="AdminUserColumns"/>
        FROM admin_user
        WHERE id = #{id} AND deleted = 0
    </select>
    
    <!-- 根据账号查找管理员 -->
    <select id="findByUsername" resultMap="AdminUserMap">
        SELECT <include refid="AdminUserColumns"/>
        FROM admin_user
        WHERE username = #{username} AND deleted = 0
    </select>
    
    <!-- 根据手机号查找管理员 -->
    <select id="findByMobile" resultMap="AdminUserMap">
        SELECT <include refid="AdminUserColumns"/>
        FROM admin_user
        WHERE mobile = #{mobile} AND deleted = 0
    </select>
    
    <!-- 根据状态查找管理员列表 -->
    <select id="findByStatus" resultMap="AdminUserMap">
        SELECT <include refid="AdminUserColumns"/>
        FROM admin_user
        WHERE deleted = 0
        <if test="status != null">
            AND status = #{status}
        </if>
        ORDER BY created_at DESC
    </select>
    
    <!-- 查找所有管理员 -->
    <select id="findAll" resultMap="AdminUserMap">
        SELECT <include refid="AdminUserColumns"/>
        FROM admin_user
        WHERE deleted = 0
        ORDER BY created_at DESC
    </select>
    
    <!-- 根据ID列表查找管理员 -->
    <select id="findAllById" resultMap="AdminUserMap">
        SELECT <include refid="AdminUserColumns"/>
        FROM admin_user
        WHERE deleted = 0 AND id IN
        <foreach collection="ids" item="id" open="(" separator="," close=")">
            #{id}
        </foreach>
        ORDER BY created_at DESC
    </select>
    
    <!-- 根据账号列表查找管理员 -->
    <select id="findAllByUsername" resultMap="AdminUserMap">
        SELECT <include refid="AdminUserColumns"/>
        FROM admin_user
        WHERE deleted = 0 AND username IN
        <foreach collection="usernames" item="username" open="(" separator="," close=")">
            #{username}
        </foreach>
        ORDER BY created_at DESC
    </select>
    
    <!-- 根据角色ID查找拥有该角色的管理员 -->
    <select id="findByRoleId" resultMap="AdminUserMap">
        SELECT au.*
        FROM admin_user au
        INNER JOIN admin_user_role aur ON au.id = aur.admin_user_id
        WHERE au.deleted = 0 AND aur.role_id = #{roleId}
        ORDER BY au.created_at DESC
    </select>
    
    <!-- 检查管理员是否存在 -->
    <select id="existsById" resultType="boolean">
        SELECT COUNT(*) > 0
        FROM admin_user
        WHERE id = #{id} AND deleted = 0
    </select>
    
    <!-- 检查管理员账号是否存在 -->
    <select id="existsByUsername" resultType="boolean">
        SELECT COUNT(*) > 0
        FROM admin_user
        WHERE username = #{username} AND deleted = 0
    </select>
    
    <!-- 检查手机号是否存在 -->
    <select id="existsByMobile" resultType="boolean">
        SELECT COUNT(*) > 0
        FROM admin_user
        WHERE mobile = #{mobile} AND deleted = 0
    </select>
    
    <!-- 统计管理员数量 -->
    <select id="count" resultType="long">
        SELECT COUNT(*)
        FROM admin_user
        WHERE deleted = 0
    </select>
    
    <!-- 根据状态统计管理员数量 -->
    <select id="countByStatus" resultType="long">
        SELECT COUNT(*)
        FROM admin_user
        WHERE deleted = 0
        <if test="status != null">
            AND status = #{status}
        </if>
    </select>
    
    <!-- 分页查询管理员 -->
    <select id="pageQuery" resultMap="AdminUserMap">
        SELECT <include refid="AdminUserColumns"/>
        FROM admin_user
        WHERE deleted = 0
        <if test="queryReq.username != null and queryReq.username != ''">
            AND username LIKE CONCAT('%', #{queryReq.username}, '%')
        </if>
        <if test="queryReq.realName != null and queryReq.realName != ''">
            AND real_name LIKE CONCAT('%', #{queryReq.realName}, '%')
        </if>
        <if test="queryReq.mobile != null and queryReq.mobile != ''">
            AND mobile LIKE CONCAT('%', #{queryReq.mobile}, '%')
        </if>
        <if test="queryReq.status != null and queryReq.status != ''">
            AND status = #{queryReq.status}
        </if>
        <if test="queryReq.roleId != null and queryReq.roleId != ''">
            AND id IN (
                SELECT admin_user_id 
                FROM admin_user_role 
                WHERE role_id = #{queryReq.roleId}
            )
        </if>
        <if test="queryReq.startTime != null and queryReq.startTime != ''">
            AND created_at <![CDATA[ >= ]]> #{queryReq.startTime}
        </if>
        <if test="queryReq.endTime != null and queryReq.endTime != ''">
            AND created_at <![CDATA[ <= ]]> #{queryReq.endTime}
        </if>
        ORDER BY created_at DESC
    </select>
</mapper>
