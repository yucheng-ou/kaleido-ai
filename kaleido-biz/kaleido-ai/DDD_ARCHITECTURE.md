# AI服务DDD架构说明

## 目录结构

```
src/main/java/com/xiaoo/kaleido/ai/
├── KaleidoAiApplication.java          # 应用启动类
├── domain/                           # 领域层
│   └── ai/                           # AI子领域
│       ├── model/                    # 领域模型
│       │   └── aggregate/            # 聚合根
│       │       └── AIConversationAggregate.java
│       ├── service/                  # 领域服务
│       │   └── AIConversationService.java
│       └── adapter/                  # 领域适配器
├── application/                      # 应用层
│   ├── command/                      # 命令处理（CQRS）
│   │   └── AIConversationCommandHandler.java
│   └── query/                        # 查询处理（CQRS）
├── infrastructure/                   # 基础设施层
│   ├── dao/                         # 数据访问对象
│   └── adapter/                     # 外部适配器
│       └── AIClientAdapter.java
├── types/                           # 类型定义层
│   └── dto/                         # 数据传输对象
│       └── AIConversationDTO.java
└── trigger/                         # 触发器层（API层）
    └── AIConversationController.java
```

## 架构设计原则

### 1. 领域驱动设计（DDD）
- **聚合根**：`AIConversationAggregate` 封装对话状态和业务规则
- **领域服务**：`AIConversationService` 处理跨聚合的业务逻辑
- **限界上下文**：AI服务作为独立的限界上下文

### 2. 清晰分层
- **领域层**：纯业务逻辑，不依赖外部框架
- **应用层**：协调领域对象，处理用例
- **基础设施层**：技术实现细节（数据库、外部API等）
- **API层**：HTTP接口，输入输出适配

### 3. CQRS模式
- **命令**：修改状态的操作（创建对话、发送消息）
- **查询**：读取状态的操作（获取对话详情）
- 命令和查询分离，便于优化和扩展

### 4. 适配器模式
- **AI客户端适配器**：统一外部AI服务接口
- **数据库适配器**：数据访问抽象（待实现）
- **消息队列适配器**：异步处理（待实现）

## AI服务特性适配

### 1. 异步处理
- AI推理通常是异步操作
- 支持流式响应（Server-Sent Events/WebSocket）
- 任务队列处理长时间运行的任务

### 2. 状态管理
- 对话状态持久化
- 上下文历史管理
- 会话超时处理

### 3. 容错机制
- AI服务调用重试
- 降级策略（备用模型）
- 熔断器模式

### 4. 成本控制
- Token使用统计
- 调用频率限制
- 预算管理

## 扩展点

### 1. 向量数据库支持
- 在infrastructure层添加VectorRepository
- 支持RAG（检索增强生成）架构

### 2. 多模型路由
- 模型选择策略
- 负载均衡和故障转移
- A/B测试支持

### 3. 监控和可观测性
- AI调用指标收集
- 响应时间监控
- 质量评估（人工反馈）

## 开发规范

### 1. 代码组织
- 每个聚合根在独立的包中
- 领域服务接口和实现分离
- DTO用于层间数据传输

### 2. 测试策略
- 领域层：单元测试，不依赖外部
- 应用层：集成测试，模拟外部依赖
- API层：端到端测试

### 3. 配置管理
- AI服务配置外部化
- 模型参数可动态调整
- 特性开关支持

## 与传统服务对比

### 相同点
- 相同的DDD分层结构
- 统一的技术栈（Spring Boot）
- 一致的开发规范

### 不同点
- AI服务更注重异步和流式处理
- 外部依赖更强（AI API）
- 状态管理更复杂（对话上下文）
- 成本控制更关键（API调用费用）

## 下一步工作

1. **完善基础设施**：
   - 实现数据库访问层
   - 添加消息队列支持
   - 配置向量数据库

2. **增强AI能力**：
   - 实现多模型支持
   - 添加RAG功能
   - 优化提示词工程

3. **完善监控**：
   - 添加调用指标
   - 实现质量评估
   - 配置告警机制

4. **性能优化**：
   - 缓存策略
   - 并发处理
   - 资源管理
