<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.xiaoo.kaleido.wardrobe.infrastructure.dao.LocationRecordDao">

    <resultMap id="BaseResultMap" type="com.xiaoo.kaleido.wardrobe.infrastructure.dao.po.LocationRecordPO">
        <id column="id" property="id"/>
        <result column="clothing_id" property="clothingId"/>
        <result column="location_id" property="locationId"/>
        <result column="user_id" property="userId"/>
        <result column="record_time" property="recordTime"/>
        <result column="is_current" property="isCurrent"/>
    </resultMap>

    <sql id="Base_Column_List">
        id, clothing_id, location_id, user_id, record_time, notes, is_current
    </sql>


    <select id="selectCurrentByClothingId" resultMap="BaseResultMap">
        SELECT
        <include refid="Base_Column_List"/>
        FROM t_wardrobe_location_record
        WHERE clothing_id = #{clothingId} AND is_current = 1 AND deleted = 0
        LIMIT 1
    </select>

    <select id="selectCurrentByLocationId" resultMap="BaseResultMap">
        SELECT
        <include refid="Base_Column_List"/>
        FROM t_wardrobe_location_record
        WHERE location_id = #{locationId} AND is_current = 1 AND deleted = 0
        ORDER BY record_time DESC
    </select>

    <select id="selectCurrentByUserId" resultMap="BaseResultMap">
        SELECT
        <include refid="Base_Column_List"/>
        FROM t_wardrobe_location_record
        WHERE user_id = #{userId} AND is_current = 1 AND deleted = 0
        ORDER BY record_time DESC
    </select>

    <select id="selectByClothingId" resultMap="BaseResultMap">
        SELECT
        <include refid="Base_Column_List"/>
        FROM t_wardrobe_location_record
        WHERE clothing_id = #{clothingId} AND deleted = 0
        ORDER BY record_time DESC
    </select>

    <update id="updateCurrentStatus">
        UPDATE t_wardrobe_location_record
        SET is_current = #{isCurrent}, updated_at = NOW()
        WHERE id = #{id} AND deleted = 0
    </update>

    <update id="markAllAsNotCurrentByClothingId">
        UPDATE t_wardrobe_location_record
        SET is_current = 0, updated_at = NOW()
        WHERE clothing_id = #{clothingId} AND is_current = 1 AND deleted = 0
    </update>

    <update id="delete">
        UPDATE t_wardrobe_location_record
        SET deleted    = 1,
            updated_at = NOW()
        WHERE id = #{id}
          AND deleted = 0
    </update>

    <select id="existsCurrentByClothingIdAndLocationId" resultType="boolean">
        SELECT COUNT(1) > 0
        FROM t_wardrobe_location_record
        WHERE clothing_id = #{clothingId}
          AND location_id = #{locationId}
          AND is_current = 1
          AND deleted = 0
    </select>

    <select id="countCurrentByLocationId" resultType="int">
        SELECT COUNT(1)
        FROM t_wardrobe_location_record
        WHERE location_id = #{locationId}
          AND is_current = 1
          AND deleted = 0
    </select>

</mapper>
