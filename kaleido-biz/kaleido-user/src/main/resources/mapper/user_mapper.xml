<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="com.xiaoo.kaleido.user.infrastructure.mapper.UserMapper">

    <resultMap id="UserMap" type="com.xiaoo.kaleido.user.domain.model.entity.User">
        <result property="id" column="id"/>
        <result property="nickName" column="nick_name"/>
        <result property="passwordHash" column="password_hash"/>
        <result property="status" column="status"/>
        <result property="inviteCode" column="invite_code"/>
        <result property="telephone" column="telephone"/>
        <result property="inviterId" column="inviter_id"/>
        <result property="avatar" column="avatar"/>
        <result property="deleted" column="deleted"/>
        <result property="lockVersion" column="lock_version"/>
        <result property="createdAt" column="created_at"/>
        <result property="updatedAt" column="updated_at"/>
    </resultMap>

    <!-- 用户表字段列表 -->
    <sql id="UserColumns">
        id, nick_name, password_hash, status, invite_code, telephone, inviter_id, avatar, deleted, lock_version, created_at, updated_at
    </sql>

    <select id="getById" resultMap="UserMap">
        select <include refid="UserColumns"/> from t_user where deleted=0
        <if test="id!=null">AND id = #{id}</if>
    </select>

    <select id="getByTelephone" resultMap="UserMap">
        select <include refid="UserColumns"/> from t_user where deleted=0
        <if test="telephone!=null">AND telephone = #{telephone}</if>
    </select>

    <select id="getByInviteCode" resultMap="UserMap">
        select <include refid="UserColumns"/> from t_user where deleted=0
        <if test="inviteCode!=null">AND invite_code = #{inviteCode}</if>
    </select>

    <select id="listUsers" resultMap="UserMap">
        select <include refid="UserColumns"/> from t_user where deleted=0
        <if test="id != null">AND id = #{id}</if>
        <if test="telephone != null and telephone != ''">AND telephone = #{telephone}</if>
        <if test="inviteCode != null and inviteCode != ''">AND invite_code = #{inviteCode}</if>
        <if test="nickName != null and nickName != ''">AND nick_name LIKE CONCAT('%', #{nickName}, '%')</if>
        ORDER BY created_at DESC
    </select>

    <select id="listUsersPage" resultMap="UserMap">
        select <include refid="UserColumns"/> from t_user where deleted=0
        <if test="request.id != null">AND id = #{request.id}</if>
        <if test="request.telephone != null and request.telephone != ''">AND telephone = #{request.telephone}</if>
        <if test="request.inviteCode != null and request.inviteCode != ''">AND invite_code = #{request.inviteCode}</if>
        <if test="request.nickName != null and request.nickName != ''">AND nick_name LIKE CONCAT('%', #{request.nickName}, '%')</if>
        ORDER BY created_at DESC
    </select>
</mapper>
