<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="com.xiaoo.kaleido.user.infrastructure.mapper.UserMapper">

    <resultMap id="UserMap" type="com.xiaoo.kaleido.user.domain.model.entity.User">
        <result property="id" column="id"/>
        <result property="nickName" column="nick_name"/>
        <result property="passwordHash" column="password_hash"/>
        <result property="status" column="status"/>
        <result property="inviteCode" column="invite_code"/>
        <result property="telephone" column="telephone"/>
        <result property="inviterId" column="inviter_id"/>
        <result property="avatar" column="avatar"/>
        <result property="deleted" column="deleted"/>
        <result property="lockVersion" column="lock_version"/>
        <result property="createdAt" column="created_at"/>
        <result property="updatedAt" column="updated_at"/>
    </resultMap>

    <!-- 用户表字段列表 -->
    <sql id="UserColumns">
        id, nick_name, password_hash, status, invite_code, telephone, inviter_id, avatar, deleted, lock_version, created_at, updated_at
    </sql>

    <!-- 用户查询条件片段 -->
    <sql id="UserQueryConditions">
        <if test="request.id != null">AND id = #{request.id}</if>
        <if test="request.telephone != null and request.telephone != ''">AND telephone LIKE CONCAT('%', #{request.telephone}, '%')</if>
        <if test="request.inviteCode != null and request.inviteCode != ''">AND invite_code LIKE CONCAT('%', #{request.inviteCode}, '%')</if>
        <if test="request.nickName != null and request.nickName != ''">AND nick_name LIKE CONCAT('%', #{request.nickName}, '%')</if>
        <if test="request.statusEnum != null">AND status = #{request.statusEnum}</if>
    </sql>

    <select id="getById" resultMap="UserMap">
        select <include refid="UserColumns"/> from t_user where deleted=0
        <if test="id!=null">AND id = #{id}</if>
    </select>

    <select id="getByTelephone" resultMap="UserMap">
        select <include refid="UserColumns"/> from t_user where deleted=0
        <if test="telephone!=null">AND telephone = #{telephone}</if>
    </select>

    <select id="getByInviteCode" resultMap="UserMap">
        select <include refid="UserColumns"/> from t_user where deleted=0
        <if test="inviteCode!=null">AND invite_code = #{inviteCode}</if>
    </select>

    <select id="query" resultMap="UserMap">
        select <include refid="UserColumns"/> from t_user where deleted=0
        <include refid="UserQueryConditions"/>
        ORDER BY created_at DESC
    </select>

    <select id="pageQuery" resultMap="UserMap">
        select <include refid="UserColumns"/> from t_user where deleted=0
        <include refid="UserQueryConditions"/>
        <if test="request.maxResult != null">LIMIT #{request.maxResult}</if>
        ORDER BY created_at DESC
    </select>

    <select id="getByIds" resultMap="UserMap">
        select <include refid="UserColumns"/> from t_user where deleted=0
        AND id IN
        <foreach collection="ids" item="id" open="(" separator="," close=")">
            #{id}
        </foreach>
        ORDER BY id DESC
    </select>
</mapper>
