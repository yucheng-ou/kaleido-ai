<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="com.xiaoo.kaleido.user.infrastructure.dao.UserOperateStreamDao">

    <resultMap id="UserOperateStreamMap" type="com.xiaoo.kaleido.user.infrastructure.dao.po.UserOperateStreamPO">
        <!-- BasePO字段 -->
        <result property="id" column="id"/>
        <result property="createdAt" column="created_at"/>
        <result property="updatedAt" column="updated_at"/>
        <result property="deleted" column="deleted"/>
        <result property="lockVersion" column="lock_version"/>
        
        <!-- UserOperateStreamPO特有字段 -->
        <result property="operateType" column="operate_type"/>
        <result property="operateDetail" column="operate_detail"/>
        <result property="operatorId" column="operator_id"/>
        <result property="operateTime" column="operate_time"/>
    </resultMap>

    <!-- 
        用户操作流水表字段列表
        包含所有用户操作流水表的字段，用于SQL语句中的字段引用
    -->
    <sql id="UserOperateStreamColumns">
        id, operate_type, operate_detail, operator_id, operate_time
    </sql>

    <!-- 
        根据用户ID查找用户操作流水列表
        查询指定用户的所有操作流水记录，按操作时间倒序排列
    -->
    <select id="findById" resultMap="UserOperateStreamMap">
        SELECT <include refid="UserOperateStreamColumns"/>
        FROM t_user_operate_stream
        WHERE id = #{id} AND deleted = 0
        ORDER BY operate_time DESC
    </select>

    <!-- 
        根据用户ID和操作类型查找用户操作流水列表
        查询指定用户特定操作类型的流水记录，按操作时间倒序排列
    -->
    <select id="findByIdAndOperateType" resultMap="UserOperateStreamMap">
        SELECT <include refid="UserOperateStreamColumns"/>
        FROM t_user_operate_stream
        WHERE id = #{id} AND operate_type = #{operateType} AND deleted = 0
        ORDER BY operate_time DESC
    </select>

    <!-- 
        根据操作者ID查找用户操作流水列表
        查询指定操作者执行的所有操作流水记录，按操作时间倒序排列
    -->
    <select id="findByOperatorId" resultMap="UserOperateStreamMap">
        SELECT <include refid="UserOperateStreamColumns"/>
        FROM t_user_operate_stream
        WHERE operator_id = #{operatorId} AND deleted = 0
        ORDER BY operate_time DESC
    </select>

    <!-- 
        根据用户ID分页查询操作流水
        查询指定用户的操作流水记录，支持分页查询，按操作时间倒序排列
    -->
    <select id="findByIdWithPage" resultMap="UserOperateStreamMap">
        SELECT <include refid="UserOperateStreamColumns"/>
        FROM t_user_operate_stream
        WHERE id = #{id} AND deleted = 0
        ORDER BY operate_time DESC
        LIMIT #{offset}, #{pageSize}
    </select>

    <!-- 
        根据用户ID查询操作流水（限制条数）
        查询指定用户的最新操作流水记录，限制返回条数，按操作时间倒序排列
    -->
    <select id="findByIdWithLimit" resultMap="UserOperateStreamMap">
        SELECT <include refid="UserOperateStreamColumns"/>
        FROM t_user_operate_stream
        WHERE id = #{id} AND deleted = 0
        ORDER BY operate_time DESC
        LIMIT #{limit}
    </select>

    <!-- 
        统计用户操作流水数量
        统计指定用户的操作流水记录总数
    -->
    <select id="countById" resultType="long">
        SELECT COUNT(*)
        FROM t_user_operate_stream
        WHERE id = #{id} AND deleted = 0
    </select>
</mapper>
